name: LibrAIrian Fork Manager

# This workflow manages interactions with users working through forks
# It provides automated guidance, contribution management, and fork-specific automation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main
      - develop
  issues:
    types: [opened, edited, labeled]
  fork:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-fork:
    name: Detect Fork and User Context
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == true || github.event.issue
    outputs:
      is-fork: ${{ steps.check.outputs.is_fork }}
      user: ${{ steps.check.outputs.user }}
      repo: ${{ steps.check.outputs.repo }}
    steps:
      - name: Check if from fork
        id: check
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "is_fork=${{ github.event.pull_request.head.repo.fork }}" >> $GITHUB_OUTPUT
            echo "user=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issues" ]; then
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "user=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

  welcome-fork-user:
    name: Welcome Fork User
    runs-on: ubuntu-latest
    needs: detect-fork
    if: needs.detect-fork.outputs.is-fork == 'true' && github.event.action == 'opened'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Welcome message for fork PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const author = context.payload.pull_request.user.login;

            const welcomeMessage = `## ðŸ‘‹ Welcome to the Databricks Reference Library, @${author}!

            Thank you for contributing from your fork! The **LibrAIrian agent** is here to help guide you through the contribution process.

            ### ðŸ¤– What happens next?

            1. **Automated Review**: Your PR will be automatically reviewed for:
               - Style compliance with our guidelines
               - Documentation completeness
               - Code example validity
               - Proper file placement in the repository structure

            2. **Automated Labeling**: Your PR will be labeled based on:
               - The pillar(s) affected (I, II, III, or IV)
               - Type of contribution (documentation, code, notebook, etc.)
               - Complexity and impact level

            3. **Guidance and Feedback**: The LibrAIrian will provide:
               - Suggestions for improvements
               - Links to relevant style guides and examples
               - Automated checks for common issues

            ### ðŸ“š Resources for Contributors

            - [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
            - [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)
            - [Repository Structure Overview](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/README.md#-repository-structure)

            ### ðŸ” Quick Self-Check

            Before maintainers review, please verify:
            - [ ] Code examples are tested and working
            - [ ] Documentation follows our markdown style guide
            - [ ] Files are placed in the correct pillar directory
            - [ ] Commit messages follow our conventions

            The LibrAIrian will automatically check these items shortly. Feel free to make updates anytime!

            ---
            *ðŸ¤– This message was automatically generated by the LibrAIrian agent system*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: welcomeMessage
            });

  analyze-contribution:
    name: Analyze Contribution
    runs-on: ubuntu-latest
    needs: detect-fork
    if: needs.detect-fork.outputs.is-fork == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files_yaml: |
            pillar_i:
              - 'pillar_i/**'
            pillar_ii:
              - 'pillar_ii/**'
            pillar_iii:
              - 'pillar_iii/**'
            pillar_iv:
              - 'pillar_iv/**'
            code:
              - 'sample_code/**'
            notebooks:
              - 'sample_notebooks/**'
            docs:
              - '**/*.md'
            config:
              - '.github/**'
              - '*.yml'
              - '*.yaml'

      - name: Analyze and label PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const labels = [];

            // Determine affected pillars
            if ('${{ steps.changed-files.outputs.pillar_i_any_changed }}' === 'true') {
              labels.push('pillar-i-core-concepts');
            }
            if ('${{ steps.changed-files.outputs.pillar_ii_any_changed }}' === 'true') {
              labels.push('pillar-ii-developer-toolkit');
            }
            if ('${{ steps.changed-files.outputs.pillar_iii_any_changed }}' === 'true') {
              labels.push('pillar-iii-mlops-devops');
            }
            if ('${{ steps.changed-files.outputs.pillar_iv_any_changed }}' === 'true') {
              labels.push('pillar-iv-enterprise');
            }

            // Determine contribution type
            if ('${{ steps.changed-files.outputs.code_any_changed }}' === 'true') {
              labels.push('code-example');
            }
            if ('${{ steps.changed-files.outputs.notebooks_any_changed }}' === 'true') {
              labels.push('notebook');
            }
            if ('${{ steps.changed-files.outputs.docs_any_changed }}' === 'true') {
              labels.push('documentation');
            }
            if ('${{ steps.changed-files.outputs.config_any_changed }}' === 'true') {
              labels.push('configuration');
            }

            // Add fork contribution label
            labels.push('fork-contribution');

            // Apply labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: labels
              });
            }

            // Post analysis summary
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const summary = `## ðŸ” LibrAIrian Contribution Analysis

            **Affected Areas**: ${labels.filter(l => l.startsWith('pillar-')).join(', ') || 'None'}
            **Contribution Type**: ${labels.filter(l => !l.startsWith('pillar-') && l !== 'fork-contribution').join(', ') || 'General'}
            **Files Changed**: ${changedFiles.length}

            ### Labels Applied
            ${labels.map(l => `- \`${l}\``).join('\n')}

            The LibrAIrian has automatically categorized your contribution. Maintainers will be notified based on these labels.

            ---
            *ðŸ¤– Automated analysis by LibrAIrian*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summary
            });

  provide-guidance:
    name: Provide Contextual Guidance
    runs-on: ubuntu-latest
    needs: [detect-fork, analyze-contribution]
    if: needs.detect-fork.outputs.is-fork == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Analyze PR for common issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;

            // Get PR files
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const suggestions = [];

            // Check for common issues
            files.data.forEach(file => {
              // Check if Python files follow naming conventions
              if (file.filename.endsWith('.py')) {
                if (file.filename.includes(' ')) {
                  suggestions.push(`âš ï¸ File \`${file.filename}\` contains spaces. Consider using underscores instead.`);
                }
                if (!file.filename.match(/^[a-z_][a-z0-9_]*\.py$/)) {
                  suggestions.push(`â„¹ï¸ File \`${file.filename}\` should use snake_case naming convention.`);
                }
              }

              // Check if notebooks are in correct location
              if (file.filename.endsWith('.ipynb')) {
                if (!file.filename.startsWith('sample_notebooks/')) {
                  suggestions.push(`ðŸ““ Notebook \`${file.filename}\` should be placed in \`sample_notebooks/\` directory.`);
                }
              }

              // Check if markdown files have proper location
              if (file.filename.endsWith('.md') && !file.filename.startsWith('pillar_') && !file.filename.match(/^[A-Z_]+\.md$/)) {
                suggestions.push(`ðŸ“ Markdown file \`${file.filename}\` may need to be placed in an appropriate pillar directory.`);
              }
            });

            // Post guidance if there are suggestions
            if (suggestions.length > 0) {
              const guidanceMessage = `## ðŸ’¡ LibrAIrian Guidance

              I've noticed some items that might need attention:

              ${suggestions.join('\n')}

              ### Reference Documentation
              - [Style Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#style-guidelines)
              - [Repository Structure](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#repository-structure)

              These are suggestions to help ensure consistency with the repository standards. Feel free to ask questions if you need clarification!

              ---
              *ðŸ¤– Guidance provided by LibrAIrian*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: guidanceMessage
              });
            }

  manage-issue:
    name: Manage Issue from User
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto-triage issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title.toLowerCase();
            const issueBody = context.payload.issue.body ? context.payload.issue.body.toLowerCase() : '';

            const labels = [];

            // Auto-detect issue type
            if (issueTitle.includes('bug') || issueBody.includes('error') || issueBody.includes('broken')) {
              labels.push('bug');
            } else if (issueTitle.includes('feature') || issueTitle.includes('enhancement') || issueBody.includes('add')) {
              labels.push('enhancement');
            } else if (issueTitle.includes('question') || issueTitle.includes('how')) {
              labels.push('question');
            } else if (issueTitle.includes('documentation') || issueTitle.includes('docs')) {
              labels.push('documentation');
            }

            // Detect affected pillar
            if (issueBody.includes('pillar i') || issueBody.includes('pillar_i') || issueBody.includes('core concept')) {
              labels.push('pillar-i-core-concepts');
            }
            if (issueBody.includes('pillar ii') || issueBody.includes('pillar_ii') || issueBody.includes('pyspark') || issueBody.includes('sql')) {
              labels.push('pillar-ii-developer-toolkit');
            }
            if (issueBody.includes('pillar iii') || issueBody.includes('pillar_iii') || issueBody.includes('github') || issueBody.includes('ci/cd')) {
              labels.push('pillar-iii-mlops-devops');
            }
            if (issueBody.includes('pillar iv') || issueBody.includes('pillar_iv') || issueBody.includes('power bi') || issueBody.includes('enterprise')) {
              labels.push('pillar-iv-enterprise');
            }

            // Apply labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: labels
              });
            }

            // Post acknowledgment
            const responseMessage = `## ðŸ‘‹ Thank you for opening this issue!

            The **LibrAIrian agent** has automatically triaged your issue and applied relevant labels.

            ${labels.length > 0 ? `**Labels Applied**: ${labels.map(l => \`\\\`${l}\\\`\`).join(', ')}` : ''}

            A maintainer will review your issue soon. In the meantime:

            - Make sure you've provided all necessary details
            - Check if similar issues already exist
            - Review our [Contributing Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md) for more information

            ---
            *ðŸ¤– This message was automatically generated by the LibrAIrian agent system*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: responseMessage
            });
